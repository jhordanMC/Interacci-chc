<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lugar de Atención - Sistema de Citas Médicas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
          integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
          crossorigin=""/>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
            integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
            crossorigin=""></script>
    <!-- Leaflet Routing Machine CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />
    <!-- Leaflet Routing Machine JS -->
    <script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
    <style>
        body {
            background-image: url('https://dondemeatiendo.essalud.gob.pe/assets/images/fondo-back-01.png');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #333;
            font-family: Arial, sans-serif;
        }
        .top-container {
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 10px 20px;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            background-color: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(5px);
        }
        .top-logo-container img {
            height: 60px;
            max-width: 100%;
        }
        .content {
            margin-top: 80px;
            padding: 20px;
            width: 100%;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            align-items: flex-start;
            flex-grow: 1;
            gap: 20px;
            position: relative;
        }
        .info-panel {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
            min-width: 350px;
        }
        .map-panel {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            flex-grow: 1;
            min-height: 600px;
        }
        #map {
            width: 100%;
            height: 500px;
            border-radius: 8px;
            border: 1px solid #ddd;
        }
        .button {
            background-color: #0078D7;
            color: white;
            border: none;
            padding: 12px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
            margin: 5px 0;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .button:hover {
            background-color: #005ea6;
        }
        .button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        .button-success {
            background-color: #28a745;
        }
        .button-success:hover {
            background-color: #218838;
        }
        .button-warning {
            background-color: #ffc107;
            color: #212529;
        }
        .button-warning:hover {
            background-color: #e0a800;
        }
        .user-menu-button {
            width: 40px;
            height: 40px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            text-decoration: none;
            transition: background-color 0.3s;
        }
        .user-menu-button:hover {
            background-color: #c0c0c0;
        }
        .user-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 20px;
            width: 150px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 1000;
        }
        .user-menu a {
            display: block;
            padding: 8px 16px;
            color: #333;
            text-decoration: none;
        }
        .user-menu a:hover {
            background-color: #f0f0f0;
        }
        .home-button {
            display: flex;
            align-items: center;
            gap: 8px;
            background-color: #0078D7;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s, transform 0.2s;
            text-decoration: none;
        }
        .home-button:hover {
            background-color: #005ea6;
            transform: translateY(-1px);
        }
        .home-icon {
            width: 24px;
            height: 24px;
            filter: none;
        }
        .home-text {
            font-size: 14px;
        }
        .hospital-info {
            background-color: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #0078D7;
        }
        .hospital-info h3 {
            margin: 0 0 10px 0;
            color: #0078D7;
            font-size: 1.2rem;
            font-weight: bold;
        }
        .info-item {
            margin: 8px 0;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }
        .info-label {
            font-weight: bold;
            color: #666;
            min-width: 80px;
        }
        .info-value {
            color: #333;
            flex: 1;
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }
        .close-button {
            position: absolute;
            top: 10px;
            right: 10px;
            font-size: 1.5rem;
            cursor: pointer;
            color: #333;
            background: none;
            border: none;
        }
        .bus-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
            background-color: #f8f9fa;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .bus-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .bus-image {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 5px;
            border: 2px solid #0078D7;
        }
        .bus-info {
            flex: 1;
        }
        .bus-name {
            font-weight: bold;
            color: #0078D7;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }
        .bus-route {
            color: #666;
            font-size: 0.9rem;
            margin-bottom: 3px;
        }
        .bus-time {
            color: #28a745;
            font-weight: bold;
            font-size: 0.9rem;
        }
        .bus-type {
            background-color: #0078D7;
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: bold;
            display: inline-block;
            margin-left: 10px;
        }
        .bus-type.metro {
            background-color: #28a745;
        }
        .bus-type.combi {
            background-color: #ffc107;
            color: #212529;
        }
        .bus-type.colectivo {
            background-color: #dc3545;
        }
        .bus-type.brt {
            background-color: #6f42c1;
        }
        .recommendations {
            background-color: #e7f3ff;
            border: 1px solid #b3d9ff;
            border-radius: 8px;
            padding: 15px;
            margin-top: 20px;
        }
        .recommendations h4 {
            color: #0078D7;
            margin: 0 0 10px 0;
            font-size: 1.1rem;
        }
        .recommendations ul {
            margin: 0;
            padding-left: 20px;
        }
        .recommendations li {
            margin: 5px 0;
            color: #333;
        }
        .location-status {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .location-granted {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .location-denied {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #0078D7;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @media (max-width: 768px) {
            .content {
                flex-direction: column;
            }
            .info-panel {
                max-width: 100%;
                min-width: auto;
            }
            .map-panel {
                min-height: 400px;
            }
            #map {
                height: 350px;
            }
        }
    </style>
</head>
<body>
    <div class="top-container">
        <div class="top-logo-container">
            <img src="https://dondemeatiendo.essalud.gob.pe/assets/images/logo-essalud-v2.png" alt="Logo EsSalud" loading="lazy">
        </div>
        <div class="relative flex items-center gap-3">
            <button id="home-btn" class="home-button" title="Volver al inicio">
                <img src="https://cdn-icons-png.flaticon.com/512/9073/9073032.png" alt="Inicio" class="home-icon" loading="lazy">
                <span class="home-text">Volver</span>
            </button>
            <button id="user-menu-button" class="user-menu-button">
                <span id="user-initials">U</span>
            </button>
            <div id="user-menu" class="user-menu">
                <a href="#" id="logout">Cerrar sesión</a>
            </div>
        </div>
    </div>

    <div class="content">
        <!-- Panel de Información -->
        <div class="info-panel">
            <h2 class="text-2xl font-semibold text-blue-600 mb-4">Centro de Atención</h2>
            
            <!-- Selector de Hospital -->
            <div class="mb-4">
                <label for="hospital-select" class="block text-gray-700 font-medium mb-2">Seleccionar Centro de Atención</label>
                <select id="hospital-select" class="p-2 border border-gray-300 rounded-md w-full focus:outline-none focus:ring-2 focus:ring-blue-500">
                    <option value="" disabled selected>Selecciona un centro</option>
                </select>
            </div>

            <!-- Estado de Ubicación -->
            <div id="location-status" class="location-status" style="display: none;"></div>

            <!-- Información del Hospital -->
            <div id="hospital-details" class="hospital-info" style="display: none;">
                <h3 id="hospital-name"></h3>
                <div class="info-item">
                    <span class="info-label">📍 Dirección:</span>
                    <span class="info-value" id="hospital-address"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">📞 Teléfono:</span>
                    <span class="info-value" id="hospital-phone"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">🏢 Distrito:</span>
                    <span class="info-value" id="hospital-district"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">🕐 Horarios:</span>
                    <span class="info-value" id="hospital-hours"></span>
                </div>
                <div class="info-item">
                    <span class="info-label">🚌 Transporte:</span>
                    <span class="info-value" id="hospital-transport"></span>
                </div>
            </div>

            <!-- Botones de Acción -->
            <div id="action-buttons" style="display: none;">
                <button id="generate-route-btn" class="button button-success">
                    🗺️ Generar Ruta
                </button>
                <button id="show-buses-btn" class="button button-warning">
                    🚌 Ver Buses
                </button>
                <button id="enable-location-btn" class="button" style="display: none;">
                    📍 Activar Ubicación
                </button>
            </div>

            <!-- Recomendaciones -->
            <div id="recommendations" class="recommendations" style="display: none;">
                <h4>💡 Recomendaciones</h4>
                <ul id="recommendations-list"></ul>
            </div>
        </div>

        <!-- Panel del Mapa -->
        <div class="map-panel">
            <h3 class="text-xl font-semibold text-blue-600 mb-4">Ubicación y Rutas</h3>
            <div id="map-loading" class="loading">
                <div class="spinner"></div>
                <p>Cargando mapa...</p>
            </div>
            <div id="map" style="display: none;"></div>
        </div>
    </div>

    <!-- Modal para Buses -->
    <div id="buses-modal" class="modal">
        <div class="modal-content">
            <button class="close-button" id="close-buses-modal">&times;</button>
            <h3 class="text-xl font-semibold text-blue-600 mb-4">🚌 Transporte Público</h3>
            <div id="buses-container">
                <!-- Buses se cargarán aquí -->
            </div>
        </div>
    </div>

    <script>
        // Verificar sesión al cargar la página
        window.addEventListener('DOMContentLoaded', function() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('No has iniciado sesión. Serás redirigido a la página de inicio.');
                window.location.href = 'index.html';
                return;
            }
            personalizeScripts();
            loadHospitals();
            
            // Inicializar mapa después de que la página esté completamente cargada
            setTimeout(() => {
                initializeMap();
            }, 100);
        });

        // Datos de hospitales con información completa
        const hospitalData = {
            'Hospital Nacional Edgardo Rebagliati Martins': {
                direccion: 'Av. Edgardo Rebagliati 490, Jesús María, Lima',
                telefono: '(01) 265-4901',
                distrito: 'Jesús María',
                horarios: 'Lunes a Viernes: 7:00 AM - 7:00 PM<br>Sábados: 8:00 AM - 2:00 PM',
                lat: -12.0784,
                lng: -77.0511,
                transporte: 'Metropolitano, Línea 1 del Metro, múltiples líneas de buses',
                buses: [
                    {
                        nombre: 'Metropolitano - Estación Angamos',
                        ruta: 'Naranjal - Matellini',
                        tiempo: '15-20 min desde estación',
                        tipo: 'BRT',
                        imagen: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/Metropolitano_Lima_Bus.jpg/300px-Metropolitano_Lima_Bus.jpg'
                    },
                    {
                        nombre: 'Línea 1 Metro - Estación Gamarra',
                        ruta: 'Villa El Salvador - San Juan de Lurigancho',
                        tiempo: '10 min caminando desde estación',
                        tipo: 'Metro',
                        imagen: 'https://upload.wikimedia.org/wikipedia/commons/thumb/2/2c/Metro_de_Lima_tren.jpg/300px-Metro_de_Lima_tren.jpg'
                    },
                    {
                        nombre: 'Bus 101 - Av. Brasil',
                        ruta: 'Callao - Centro de Lima',
                        tiempo: '5 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Los Portales del Norte"',
                        ruta: 'Independencia - San Borja',
                        tiempo: 'Paradero frente al hospital',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "San Borja Express"',
                        ruta: 'San Borja - Jesús María',
                        tiempo: '3 min caminando',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Bus 204 - Línea Verde',
                        ruta: 'Ate - Magdalena',
                        tiempo: '8 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1570125909517-53cb21c89ff2?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Jesús María Directo"',
                        ruta: 'Lima Centro - Jesús María',
                        tiempo: 'Paradero a 2 cuadras',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    }
                ],
                recomendaciones: [
                    'Llegar 30 minutos antes de su cita',
                    'Traer DNI original y copia',
                    'Usar mascarilla obligatoriamente',
                    'El estacionamiento tiene costo adicional',
                    'Hay cafetería y farmacia en el primer piso'
                ]
            },
            'Hospital Guillermo Almenara Irigoyen': {
                direccion: 'Av. Grau 800, La Victoria, Lima',
                telefono: '(01) 324-2983',
                distrito: 'La Victoria',
                horarios: 'Lunes a Viernes: 6:30 AM - 8:00 PM<br>Sábados: 7:00 AM - 3:00 PM',
                lat: -12.0735,
                lng: -77.0316,
                transporte: 'Metropolitano, múltiples líneas de buses, combis y colectivos',
                buses: [
                    {
                        nombre: 'Metropolitano - Estación Central',
                        ruta: 'Naranjal - Matellini',
                        tiempo: '8 min caminando',
                        tipo: 'BRT',
                        imagen: 'https://upload.wikimedia.org/wikipedia/commons/thumb/f/f4/Metropolitano_Lima_Bus.jpg/300px-Metropolitano_Lima_Bus.jpg'
                    },
                    {
                        nombre: 'Bus OM-18 Av. Grau',
                        ruta: 'Callao - La Victoria',
                        tiempo: 'Paradero en la puerta',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1570125909517-53cb21c89ff2?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "La Victoria Express"',
                        ruta: 'Centro - La Victoria',
                        tiempo: 'Paradero a 1 cuadra',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "Grau Rápido"',
                        ruta: 'Plaza San Martín - La Victoria',
                        tiempo: 'Paradero frente al hospital',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Bus 301 - Línea Azul',
                        ruta: 'Callao - San Juan de Miraflores',
                        tiempo: '5 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Los Libertadores"',
                        ruta: 'Independencia - La Victoria',
                        tiempo: '3 min caminando',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "Centro Express"',
                        ruta: 'Lima Centro - La Victoria',
                        tiempo: 'Paradero a 2 cuadras',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Bus 502 - Línea Roja',
                        ruta: 'San Martín de Porres - La Victoria',
                        tiempo: '6 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1570125909517-53cb21c89ff2?w=300&h=200&fit=crop'
                    }
                ],
                recomendaciones: [
                    'Hospital con alta demanda, llegar temprano',
                    'Validar cita 24 horas antes',
                    'Hay servicios de laboratorio desde las 6:00 AM',
                    'Estacionamiento limitado, usar transporte público',
                    'Farmacia disponible las 24 horas'
                ]
            },
            'Hospital Alberto Sabogal Sologuren': {
                direccion: 'Av. Brigida Silva de Ochoa 2176, Bellavista, Callao',
                telefono: '(01) 429-7744',
                distrito: 'Bellavista',
                horarios: 'Lunes a Viernes: 7:00 AM - 6:00 PM<br>Sábados: 8:00 AM - 1:00 PM',
                lat: -12.0552,
                lng: -77.1019,
                transporte: 'Buses del Callao, combis, colectivos y líneas costeras',
                buses: [
                    {
                        nombre: 'Bus AC-06 Callao',
                        ruta: 'Centro Callao - Bellavista',
                        tiempo: 'Paradero en la puerta',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1570125909517-53cb21c89ff2?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Bellavista Directo"',
                        ruta: 'Lima - Callao',
                        tiempo: '5 min caminando',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "Callao Express"',
                        ruta: 'Centro Lima - Callao',
                        tiempo: '3 min caminando',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Bus 102 - La Punta',
                        ruta: 'Callao - La Punta',
                        tiempo: '3 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1558618666-fcd25c85cd64?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Los Chalaquitos"',
                        ruta: 'Callao Centro - Bellavista',
                        tiempo: 'Paradero frente al hospital',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "Costa Verde"',
                        ruta: 'Miraflores - Callao',
                        tiempo: '8 min caminando',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Bus 201 - Línea Amarilla',
                        ruta: 'San Miguel - Callao',
                        tiempo: '4 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300&h=200&fit=crop'
                    }
                ],
                recomendaciones: [
                    'Especializado en atención materno-infantil',
                    'Tráfico intenso en horas punta hacia Callao',
                    'Considerar tiempo adicional de viaje',
                    'Hay área de juegos para niños',
                    'Estacionamiento gratuito disponible'
                ]
            },
            'Hospital Honorio Delgado Espinoza': {
                direccion: 'Av. Daniel Alcides Carrión S/N, Arequipa',
                telefono: '(054) 231-868',
                distrito: 'Arequipa',
                horarios: 'Lunes a Viernes: 7:00 AM - 7:00 PM<br>Emergencias: 24 horas',
                lat: -16.3988,
                lng: -71.5350,
                transporte: 'Buses urbanos de Arequipa, combis y colectivos',
                buses: [
                    {
                        nombre: 'Bus A-12 Centro',
                        ruta: 'Centro - Paucarpata',
                        tiempo: 'Paradero frente al hospital',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1570125909517-53cb21c89ff2?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Paucarpata Express"',
                        ruta: 'Cercado - Paucarpata',
                        tiempo: '2 min caminando',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "Arequipa Centro"',
                        ruta: 'Plaza de Armas - Hospital',
                        tiempo: 'Paradero en la puerta',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Bus 25 - Línea Verde AQP',
                        ruta: 'Yanahuara - Paucarpata',
                        tiempo: '5 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Los Andinos"',
                        ruta: 'Cerro Colorado - Centro',
                        tiempo: '6 min caminando',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    }
                ],
                recomendaciones: [
                    'Hospital regional de referencia',
                    'Considerar la altura (2335 msnm)',
                    'Llevar abrigo, clima variable',
                    'Citas con varios meses de anticipación',
                    'Cafetería abierta desde las 7:00 AM'
                ]
            },
            'Hospital Goyeneche': {
                direccion: 'Av. Goyeneche 100, Arequipa',
                telefono: '(054) 233-818',
                distrito: 'Arequipa',
                horarios: 'Lunes a Viernes: 6:30 AM - 8:00 PM<br>Emergencias: 24 horas',
                lat: -16.4055,
                lng: -71.5220,
                transporte: 'Buses urbanos, combis del centro histórico',
                buses: [
                    {
                        nombre: 'Bus B-20 Centro',
                        ruta: 'Centro - Sachaca',
                        tiempo: 'Paradero a 1 cuadra',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1570125909517-53cb21c89ff2?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Plaza Express"',
                        ruta: 'Plaza de Armas - Goyeneche',
                        tiempo: '5 min caminando',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "Centro Histórico"',
                        ruta: 'Catedral - Hospital',
                        tiempo: '3 min caminando',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Bus 18 - Línea Azul AQP',
                        ruta: 'Cayma - Centro',
                        tiempo: '4 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Goyeneche Directo"',
                        ruta: 'Miraflores AQP - Centro',
                        tiempo: 'Paradero frente al hospital',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    }
                ],
                recomendaciones: [
                    'Hospital histórico de Arequipa',
                    'Especializado en medicina general',
                    'Fácil acceso desde el centro histórico',
                    'Estacionamiento en calles aledañas',
                    'Cerca de farmacias y bancos'
                ]
            },
            'Hospital Regional Docente de Trujillo': {
                direccion: 'Av. Mansiche 795, Trujillo',
                telefono: '(044) 231-581',
                distrito: 'Trujillo',
                horarios: 'Lunes a Viernes: 7:00 AM - 6:00 PM<br>Sábados: 8:00 AM - 2:00 PM',
                lat: -8.1116,
                lng: -79.0287,
                transporte: 'Buses urbanos de Trujillo, combis y colectivos',
                buses: [
                    {
                        nombre: 'Bus H-12 Mansiche',
                        ruta: 'Centro - Mansiche',
                        tiempo: 'Paradero en la esquina',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1570125909517-53cb21c89ff2?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Los Libertadores TRU"',
                        ruta: 'Centro - La Esperanza',
                        tiempo: '3 min caminando',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "Mansiche Express"',
                        ruta: 'Plaza de Armas - Mansiche',
                        tiempo: 'Paradero frente al hospital',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Bus 45 - Línea Norte',
                        ruta: 'El Porvenir - Centro',
                        tiempo: '5 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Trujillo Norte"',
                        ruta: 'Huanchaco - Centro',
                        tiempo: '7 min caminando',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "La Esperanza"',
                        ruta: 'La Esperanza - Mansiche',
                        tiempo: '4 min caminando',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    }
                ],
                recomendaciones: [
                    'Hospital de alta complejidad',
                    'Referente en el norte del país',
                    'Programar citas con anticipación',
                    'Clima cálido, ropa ligera',
                    'Estacionamiento con vigilancia'
                ]
            },
            'Hospital Belén de Trujillo': {
                direccion: 'Jr. Bolívar 350, Trujillo',
                telefono: '(044) 245-281',
                distrito: 'Trujillo',
                horarios: 'Lunes a Viernes: 7:00 AM - 5:00 PM<br>Emergencias: 24 horas',
                lat: -8.1087,
                lng: -79.0293,
                transporte: 'Buses urbanos del centro histórico, combis y colectivos',
                buses: [
                    {
                        nombre: 'Bus A-15 Centro',
                        ruta: 'Plaza de Armas - Belén',
                        tiempo: 'Paradero frente al hospital',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1570125909517-53cb21c89ff2?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Centro Histórico TRU"',
                        ruta: 'Catedral - Belén',
                        tiempo: '2 min caminando',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "Belén Express"',
                        ruta: 'Plaza Mayor - Hospital',
                        tiempo: 'Paradero en la puerta',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Bus 22 - Línea Histórica',
                        ruta: 'Centro - Moche',
                        tiempo: '3 min caminando',
                        tipo: 'Bus',
                        imagen: 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Combi "Los Mocheros"',
                        ruta: 'Moche - Centro',
                        tiempo: '5 min caminando',
                        tipo: 'Combi',
                        imagen: 'https://images.unsplash.com/photo-1558618047-3c8c76ca7d13?w=300&h=200&fit=crop'
                    },
                    {
                        nombre: 'Colectivo "Trujillo Colonial"',
                        ruta: 'Chan Chan - Centro',
                        tiempo: '6 min caminando',
                        tipo: 'Colectivo',
                        imagen: 'https://images.unsplash.com/photo-1449824913935-59a10b8d2000?w=300&h=200&fit=crop'
                    }
                ],
                recomendaciones: [
                    'Hospital centenario de Trujillo',
                    'Ubicado en el centro histórico',
                    'Fácil acceso a pie desde Plaza de Armas',
                    'Estacionamiento limitado',
                    'Cerca de servicios turísticos'
                ]
            }
        };

        // Variables globales
        let map = null;
        let userLocation = null;
        let hospitalMarker = null;
        let userMarker = null;
        let routeControl = null;
        let selectedHospital = null;

        // Elementos del DOM
        const hospitalSelect = document.getElementById('hospital-select');
        const locationStatus = document.getElementById('location-status');
        const hospitalDetails = document.getElementById('hospital-details');
        const actionButtons = document.getElementById('action-buttons');
        const recommendations = document.getElementById('recommendations');
        const generateRouteBtn = document.getElementById('generate-route-btn');
        const showBusesBtn = document.getElementById('show-buses-btn');
        const enableLocationBtn = document.getElementById('enable-location-btn');
        const busesModal = document.getElementById('buses-modal');
        const closeBusesModal = document.getElementById('close-buses-modal');
        const busesContainer = document.getElementById('buses-container');
        const mapLoading = document.getElementById('map-loading');
        const mapDiv = document.getElementById('map');
        const userMenuButton = document.getElementById('user-menu-button');
        const userMenu = document.getElementById('user-menu');
        const logoutLink = document.getElementById('logout');
        const homeBtn = document.getElementById('home-btn');

        // Personalizar iniciales del usuario
        function personalizeScripts() {
            const workerName = localStorage.getItem('workerName') || 'Usuario';
            const initials = workerName.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
            document.getElementById('user-initials').textContent = initials;
        }

        // Inicializar mapa
        function initializeMap() {
            try {
                console.log('Iniciando mapa...');
                
                // Verificar que Leaflet esté disponible
                if (typeof L === 'undefined') {
                    throw new Error('Leaflet no está cargado');
                }
                
                // Crear el mapa
                map = L.map('map', {
                    center: [-12.0464, -77.0428], // Lima como centro por defecto
                    zoom: 11,
                    zoomControl: true
                });
                
                // Agregar capa de tiles
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    attribution: '© OpenStreetMap contributors',
                    maxZoom: 19
                }).addTo(map);

                console.log('Mapa creado correctamente');
                
                // Ocultar loading y mostrar mapa
                mapLoading.style.display = 'none';
                mapDiv.style.display = 'block';
                
                // Invalidar tamaño después de mostrar
                setTimeout(() => {
                    map.invalidateSize();
                }, 250);

                // Solicitar ubicación del usuario
                requestUserLocation();
                
            } catch (error) {
                console.error('Error inicializando mapa:', error);
                mapLoading.innerHTML = `
                    <div style="text-align: center; padding: 20px;">
                        <p style="color: red; margin-bottom: 10px;">⚠️ Error cargando el mapa</p>
                        <p style="color: #666; font-size: 0.9rem;">${error.message}</p>
                        <button onclick="initializeMap()" class="button" style="margin-top: 10px; width: auto; padding: 8px 16px;">
                            🔄 Reintentar
                        </button>
                    </div>
                `;
            }
        }

        // Cargar lista de hospitales
        function loadHospitals() {
            Object.keys(hospitalData).forEach(hospital => {
                const option = document.createElement('option');
                option.value = hospital;
                option.textContent = hospital;
                hospitalSelect.appendChild(option);
            });
        }

        // Solicitar ubicación del usuario
        function requestUserLocation() {
            if (navigator.geolocation) {
                locationStatus.style.display = 'block';
                locationStatus.className = 'location-status';
                locationStatus.innerHTML = '<div class="spinner"></div>Obteniendo su ubicación...';

                navigator.geolocation.getCurrentPosition(
                    function(position) {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        locationStatus.className = 'location-status location-granted';
                        locationStatus.innerHTML = '✅ Ubicación obtenida correctamente';
                        
                        // Agregar marcador del usuario
                        userMarker = L.marker([userLocation.lat, userLocation.lng])
                            .addTo(map)
                            .bindPopup('📍 Su ubicación actual')
                            .openPopup();

                        // Centrar mapa en la ubicación del usuario
                        map.setView([userLocation.lat, userLocation.lng], 13);
                    },
                    function(error) {
                        locationStatus.className = 'location-status location-denied';
                        let message = '';
                        switch(error.code) {
                            case error.PERMISSION_DENIED:
                                message = '❌ Ubicación denegada por el usuario';
                                break;
                            case error.POSITION_UNAVAILABLE:
                                message = '❌ Ubicación no disponible';
                                break;
                            case error.TIMEOUT:
                                message = '❌ Tiempo agotado obteniendo ubicación';
                                break;
                            default:
                                message = '❌ Error desconocido obteniendo ubicación';
                                break;
                        }
                        locationStatus.innerHTML = message;
                        enableLocationBtn.style.display = 'block';
                    }
                );
            } else {
                locationStatus.style.display = 'block';
                locationStatus.className = 'location-status location-denied';
                locationStatus.innerHTML = '❌ Geolocalización no soportada por este navegador';
            }
        }

        // Mostrar información del hospital seleccionado
        function showHospitalInfo(hospitalName) {
            const hospital = hospitalData[hospitalName];
            selectedHospital = hospitalName;
            
            document.getElementById('hospital-name').textContent = hospitalName;
            document.getElementById('hospital-address').textContent = hospital.direccion;
            document.getElementById('hospital-phone').textContent = hospital.telefono;
            document.getElementById('hospital-district').textContent = hospital.distrito;
            document.getElementById('hospital-hours').innerHTML = hospital.horarios;
            document.getElementById('hospital-transport').textContent = hospital.transporte;
            
            hospitalDetails.style.display = 'block';
            actionButtons.style.display = 'block';
            
            // Mostrar recomendaciones
            showRecommendations(hospital.recomendaciones);
            
            // Agregar marcador del hospital al mapa
            if (hospitalMarker) {
                map.removeLayer(hospitalMarker);
            }
            
            hospitalMarker = L.marker([hospital.lat, hospital.lng])
                .addTo(map)
                .bindPopup(`🏥 ${hospitalName}<br>${hospital.direccion}`)
                .openPopup();
            
            // Centrar mapa en el hospital
            map.setView([hospital.lat, hospital.lng], 15);
            
            // Habilitar botón de ruta si hay ubicación del usuario
            if (userLocation) {
                generateRouteBtn.disabled = false;
            }
        }

        // Mostrar recomendaciones
        function showRecommendations(recommendationsList) {
            const recommendationsListEl = document.getElementById('recommendations-list');
            recommendationsListEl.innerHTML = '';
            
            recommendationsList.forEach(rec => {
                const li = document.createElement('li');
                li.textContent = rec;
                recommendationsListEl.appendChild(li);
            });
            
            recommendations.style.display = 'block';
        }

        // Generar ruta
        function generateRoute() {
            if (!userLocation || !selectedHospital) {
                alert('Se necesita la ubicación del usuario y un hospital seleccionado');
                return;
            }

            if (!map) {
                alert('El mapa no está disponible');
                return;
            }

            const hospital = hospitalData[selectedHospital];
            
            try {
                // Remover ruta anterior si existe
                if (routeControl) {
                    map.removeControl(routeControl);
                }

                // Verificar si Leaflet Routing Machine está disponible
                if (typeof L.Routing === 'undefined') {
                    // Fallback: crear línea directa si no hay routing
                    const routeLine = L.polyline([
                        [userLocation.lat, userLocation.lng],
                        [hospital.lat, hospital.lng]
                    ], {
                        color: '#0078D7',
                        weight: 4,
                        opacity: 0.7
                    }).addTo(map);
                    
                    // Ajustar vista
                    const group = new L.featureGroup([userMarker, hospitalMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                    
                    alert('Ruta básica generada. Para rutas detalladas, verifique su conexión a internet.');
                    return;
                }

                // Crear nueva ruta con Leaflet Routing Machine
                routeControl = L.Routing.control({
                    waypoints: [
                        L.latLng(userLocation.lat, userLocation.lng),
                        L.latLng(hospital.lat, hospital.lng)
                    ],
                    routeWhileDragging: false,
                    addWaypoints: false,
                    createMarker: function() { return null; }, // No crear marcadores adicionales
                    lineOptions: {
                        styles: [{ color: '#0078D7', weight: 4, opacity: 0.7 }]
                    },
                    show: false, // Ocultar instrucciones por defecto
                    collapsible: true
                }).addTo(map);

                // Ajustar vista para mostrar toda la ruta
                setTimeout(() => {
                    const group = new L.featureGroup([userMarker, hospitalMarker]);
                    map.fitBounds(group.getBounds().pad(0.1));
                }, 1000);
                
            } catch (error) {
                console.error('Error generando ruta:', error);
                alert('Error al generar la ruta. Intente nuevamente.');
            }
        }

        // Mostrar buses
        function showBuses() {
            if (!selectedHospital) {
                alert('Primero selecciona un hospital');
                return;
            }

            const hospital = hospitalData[selectedHospital];
            busesContainer.innerHTML = '';

            // Agregar título con contador
            const titleDiv = document.createElement('div');
            titleDiv.innerHTML = `
                <p style="text-align: center; color: #666; margin-bottom: 20px;">
                    <strong>${hospital.buses.length} opciones de transporte disponibles</strong>
                </p>
            `;
            busesContainer.appendChild(titleDiv);

            hospital.buses.forEach((bus, index) => {
                const busCard = document.createElement('div');
                busCard.className = 'bus-card';
                
                // Determinar clase de tipo
                let tipoClass = '';
                switch(bus.tipo.toLowerCase()) {
                    case 'metro':
                        tipoClass = 'metro';
                        break;
                    case 'combi':
                        tipoClass = 'combi';
                        break;
                    case 'colectivo':
                        tipoClass = 'colectivo';
                        break;
                    case 'brt':
                        tipoClass = 'brt';
                        break;
                    default:
                        tipoClass = '';
                }
                
                busCard.innerHTML = `
                    <img src="${bus.imagen}" alt="${bus.nombre}" class="bus-image" onerror="this.src='https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300&h=200&fit=crop'">
                    <div class="bus-info">
                        <div class="bus-name">
                            ${bus.nombre}
                            <span class="bus-type ${tipoClass}">${bus.tipo}</span>
                        </div>
                        <div class="bus-route">📍 Ruta: ${bus.ruta}</div>
                        <div class="bus-time">⏱️ Tiempo: ${bus.tiempo}</div>
                    </div>
                `;
                
                busesContainer.appendChild(busCard);
            });

            // Agregar información adicional
            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `
                <div style="margin-top: 20px; padding: 15px; background-color: #e7f3ff; border-radius: 8px; border-left: 4px solid #0078D7;">
                    <h4 style="margin: 0 0 10px 0; color: #0078D7;">💡 Consejos de Transporte</h4>
                    <ul style="margin: 0; padding-left: 20px; color: #333;">
                        <li>Verifique horarios de operación antes de viajar</li>
                        <li>Mantenga su dinero en efectivo para el pasaje</li>
                        <li>En horas punta, considere tiempo adicional de viaje</li>
                        <li>Para el Metropolitano y Metro, puede usar tarjeta Lima Pass</li>
                        <li>Pregunte al conductor si el vehículo pasa por el hospital</li>
                    </ul>
                </div>
            `;
            busesContainer.appendChild(infoDiv);

            busesModal.style.display = 'flex';
        }

        // Event Listeners
        hospitalSelect.addEventListener('change', function() {
            const hospitalName = this.value;
            if (hospitalName) {
                showHospitalInfo(hospitalName);
            }
        });

        generateRouteBtn.addEventListener('click', generateRoute);
        showBusesBtn.addEventListener('click', showBuses);

        enableLocationBtn.addEventListener('click', function() {
            requestUserLocation();
            this.style.display = 'none';
        });

        closeBusesModal.addEventListener('click', function() {
            busesModal.style.display = 'none';
        });

        busesModal.addEventListener('click', function(e) {
            if (e.target === busesModal) {
                busesModal.style.display = 'none';
            }
        });

        // Menú de usuario
        userMenuButton.addEventListener('click', function(e) {
            userMenu.style.display = userMenu.style.display === 'block' ? 'none' : 'block';
            e.stopPropagation();
        });

        // Cerrar sesión
        logoutLink.addEventListener('click', function(e) {
            e.preventDefault();
            const confirmLogout = confirm("¿Estás seguro de que deseas cerrar sesión?");
            if (confirmLogout) {
                localStorage.clear();
                alert("Sesión cerrada correctamente.");
                window.location.href = 'index.html';
            }
            userMenu.style.display = 'none';
        });

        // Cerrar menú de usuario al hacer clic fuera
        document.addEventListener('click', function(e) {
            if (!userMenu.contains(e.target) && e.target !== userMenuButton) {
                userMenu.style.display = 'none';
            }
        });

        // Botón Volver
        homeBtn.addEventListener('click', function() {
            window.location.href = 'PrimerModulo.html';
        });

        // Manejar errores de imágenes de buses
        document.addEventListener('error', function(e) {
            if (e.target.tagName === 'IMG' && e.target.classList.contains('bus-image')) {
                e.target.src = 'https://images.unsplash.com/photo-1544620347-c4fd4a3d5957?w=300&h=200&fit=crop';
            }
        }, true);

        // Precargar el hospital si viene de otra página
        window.addEventListener('load', function() {
            // Asegurar que el mapa esté completamente inicializado
            if (!map) {
                setTimeout(() => {
                    loadHospitalFromParams();
                }, 1000);
            } else {
                loadHospitalFromParams();
            }
        });
        
        function loadHospitalFromParams() {
            const urlParams = new URLSearchParams(window.location.search);
            const hospital = urlParams.get('hospital');
            if (hospital && hospitalData[hospital]) {
                hospitalSelect.value = hospital;
                showHospitalInfo(hospital);
            }
        }
        
        // Función global para reintentar inicialización del mapa
        window.initializeMap = initializeMap;
    </script>
</body>
</html>