<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Citas M√©dicas - EsSalud</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: white;
            font-family: Arial, sans-serif;
            text-align: center;
            background-color: white;
        }
        .top-container {
            width: 100%;
            display: flex;
            justify-content: flex-start;
            padding: 0;
            position: absolute;
            top: 0;
            left: 0;
            z-index: 1000;
            background-color: white;
        }
        .logo-section {
            background-color: white;
            padding: 0 20px;
            display: flex;
            align-items: center;
        }
        .top-logo-container img {
            height: 60px;
            max-width: 100%;
        }
        .nav-section {
            display: flex;
            align-items: center;
            background-color: #0078D7;
            padding: 10px 20px;
            border-top-left-radius: 0;
            border-bottom-left-radius: 0;
            border-top-right-radius: 0;
            margin-left: 0;
            flex-grow: 1;
        }
        .nav-buttons {
            display: flex;
            gap: 10px;
            margin-left: auto;
        }
        .nav-button {
            background-color: #0078D7;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 1rem;
            cursor: pointer;
            border-radius: 5px;
            text-align: center;
            transition: background-color 0.3s;
        }
        .nav-button:hover {
            background-color: #005ea6;
        }
        .user-menu-button {
            width: 40px;
            height: 40px;
            background-color: #e0e0e0;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 14px;
            font-weight: bold;
            color: #333;
            text-decoration: none;
            transition: background-color 0.3s;
            margin-left: 10px;
        }
        .user-menu-button:hover {
            background-color: #c0c0c0;
        }
        .user-menu {
            display: none;
            position: absolute;
            top: 50px;
            right: 20px;
            width: 150px;
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
            z-index: 1000;
        }
        .user-menu a {
            display: block;
            padding: 8px 16px;
            color: #333;
            text-decoration: none;
        }
        .user-menu a:hover {
            background-color: #f0f0f0;
        }
        
        /* MODAL PERFIL */
        .modal-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            animation: fadeIn 0.3s ease;
        }
        
        .modal-overlay.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }
        
        .modal-header {
            background: linear-gradient(135deg, #0078D7, #005ea6);
            color: white;
            padding: 20px;
            border-top-left-radius: 12px;
            border-top-right-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
        }
        
        .modal-close {
            background: transparent;
            border: none;
            color: white;
            font-size: 28px;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s;
        }
        
        .modal-close:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .modal-body {
            padding: 30px;
            color: #333;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            background: linear-gradient(135deg, #0078D7, #00b7ff);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 42px;
            color: white;
            font-weight: bold;
            margin: 0 auto 20px;
            box-shadow: 0 4px 15px rgba(0, 120, 215, 0.3);
        }
        
        .profile-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .info-row {
            display: flex;
            align-items: flex-start;
            padding: 12px;
            background-color: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #0078D7;
        }
        
        .info-label {
            font-weight: bold;
            color: #0078D7;
            min-width: 120px;
            font-size: 14px;
        }
        
        .info-value {
            color: #333;
            flex: 1;
            font-size: 14px;
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
            }
            to {
                opacity: 1;
            }
        }
        
        @keyframes slideIn {
            from {
                transform: translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        
        .content {
            margin-top: 80px;
            padding: 20px;
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            align-items: center;
            flex-grow: 1;
        }
        
        .decorative-image img {
            position: absolute;
            top: 80px;
            bottom: 0;
            left: 0;
            width: 80%;
            height: calc(100vh - 80px);
            object-fit: cover;
            z-index: 0;
        }
        
        .support-button {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 100px;
            height: 100px;
            background-color: transparent;
            border: none;
            border-radius: 50%;
            cursor: pointer;
            overflow: visible;
            z-index: 1001;
            transition: all 0.5s ease;
        }
        
        .support-button.chat-active {
            position: fixed;
            top: 50px;
            right: 105px;
            bottom: auto;
            z-index: 1002;
            width: 150px;
            height: 150px;
        }
        
        #bot-canvas {
            width: 100%;
            height: 100%;
            border-radius: 50%;
        }
        
        :root {
            --bg: #f8f9fa;
            --panel: #ffffff;
            --muted: #333;
            --accent: #0078D7;
            --ghost: #e0e0e0;
            --glass: #f0f5ff;
            --radius: 12px;
        }
        
        .chat-shell {
            width: 420px;
            max-width: 90%;
            border-radius: 16px;
            overflow: hidden;
            background: linear-gradient(135deg, #0078D7 0%, #005ea6 100%);
            box-shadow: 0 8px 30px rgba(0, 120, 215, 0.3);
            display: none;
            flex-direction: column;
            position: fixed;
            top: 80px;
            right: 20px;
            bottom: 20px;
            z-index: 1000;
            font-family: Arial, sans-serif;
        }
        
        .chat-shell.active {
            display: flex;
        }
        
        .chat-header {
            background: linear-gradient(135deg, #005ea6 0%, #004080 100%);
            padding: 16px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 2px solid rgba(255, 255, 255, 0.1);
        }

        .chat-header::before {
            content: "Ciro IA";
            color: white;
            font-weight: 600;
            font-size: 16px;
            flex: 1;
        }
        
        .chat-header button {
            background: transparent;
            border: none;
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            margin-left: 8px;
            transition: all 0.2s;
            color: white;
        }
        
        .chat-header button:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        .chat-header button svg {
            width: 20px;
            height: 20px;
            fill: white;
        }
        
        .chat-body {
            height: calc(100% - 140px);
            padding: 20px;
            overflow-y: auto;
            color: #333;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-body > p {
            background: white;
            padding: 12px 16px;
            border-radius: 12px;
            border-left: 4px solid #0078D7;
            font-size: 14px;
        }
        
        .chat-options {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin-top: 8px;
        }
        
        .chat-option-button {
            background: white;
            color: #0078D7;
            border: 1px solid #0078D7;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
            text-align: left;
        }
        
        .chat-option-button:hover {
            background: #0078D7;
            color: white;
            transform: translateX(4px);
        }
        
        .ChatFooterHoveringButtonSection_section__6i4Bc {
            position: absolute;
            right: 28px;
            bottom: 111px;
            display: none;
            gap: 8px;
            z-index: 30;
        }
        
        .chat-floating-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: linear-gradient(180deg, #0078D7, #00b7ff);
            box-shadow: 0 0 12px rgba(6,150,255,0.5);
            display: block;
            transition: transform 0.3s ease;
        }
        
        .chat-floating-dot.pulsing {
            animation: pulse 1.4s ease-in-out infinite;
        }
        
        .chat-floating-dot.pulsing:nth-child(1) {
            animation-delay: 0s;
        }
        
        .chat-floating-dot.pulsing:nth-child(2) {
            animation-delay: 0.2s;
        }
        
        .chat-floating-dot.pulsing:nth-child(3) {
            animation-delay: 0.4s;
        }
        
        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.5);
            }
        }
        
        @keyframes spin {
            0% { 
                transform: rotate(0deg); 
            }
            100% { 
                transform: rotate(360deg); 
            }
        }
        
        .ChatPageMainFooter_footerInner__BEj26 {
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: white;
            padding: 14px;
        }
        
        .ChatMessageInputFooter_footer__v4dFF {
            display: flex;
            gap: 12px;
            align-items: flex-end;
        }
        
        .ChatMessageInputContainer_inputContainer__s2AGa {
            background: white;
            border-radius: 12px;
            padding: 10px;
            display: flex;
            align-items: flex-end;
            gap: 10px;
            flex: 1;
            transition: all 0.18s;
            min-height: 46px;
            border: 1px solid #e0e0e0;
        }
        
        .ChatMessageInputContainer_inputContainer__s2AGa:focus-within {
            box-shadow: 0 4px 12px rgba(0, 120, 215, 0.2);
            border-color: #0078D7;
        }
        
        .GrowingTextArea_growWrap__im5W3 {
            position: relative;
            flex: 1;
            min-height: 28px;
            display: flex;
            align-items: flex-start;
        }
        
        textarea.GrowingTextArea_textArea__ZWQbP {
            width: 100%;
            resize: none;
            overflow: hidden;
            border: 0;
            outline: 0;
            background: transparent;
            color: #333;
            font-size: 14px;
            line-height: 1.4;
            padding: 6px 4px;
            min-height: 24px;
            max-height: 160px;
            font-family: Arial, sans-serif;
        }

        textarea.GrowingTextArea_textArea__ZWQbP::placeholder {
            color: #999;
        }
        
        .GrowingTextArea_hidden__xLW0K {
            display: none;
        }
        
        .ChatMessageInputContainer_actionContainerBase__8BKrX {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .button_root__TL8nv {
            appearance: none;
            border: 0;
            background: transparent;
            padding: 8px;
            border-radius: 8px;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .button_root__TL8nv:hover:not([disabled]) {
            background: #f0f0f0;
        }
        
        .button_root__TL8nv[disabled] {
            opacity: 0.35;
            cursor: default;
        }
        
        .button_ghost__YsMI5 {
            background: transparent;
        }
        
        .button_sm__hWzjK {
            width: 38px;
            height: 38px;
        }
        
        .button_showIconOnly-always__05Gb5 svg {
            width: 18px;
            height: 18px;
            color: #0078D7;
        }
        
        .ChatMessageInputContainer_breakSeparator__6WnHy {
            width: 1px;
            height: 28px;
            background: #e0e0e0;
            border-radius: 1px;
        }
        
        input.ChatMessageFileInputButton_input__svNx4 {
            display: none;
        }
        
        .ChatMessageInputContainer_actionContainerRight__fyfsX {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        [data-button-send] {
            background: linear-gradient(135deg, #0078D7, #005ea6);
            border-radius: 8px;
            padding: 8px;
            box-shadow: 0 4px 12px rgba(0, 120, 215, 0.3);
        }

        [data-button-send]:hover:not([disabled]) {
            box-shadow: 0 6px 16px rgba(0, 120, 215, 0.4);
            transform: translateY(-2px);
        }
        
        [data-button-send] svg {
            color: white;
        }
        
        .button_label__mCaDf {
            display: none;
        }
        
        @media (max-width: 480px) {
            .chat-shell {
                width: 100%;
                border-radius: 0;
                right: 0;
            }
            .ChatFooterHoveringButtonSection_section__6i4Bc {
                right: 16px;
                bottom: 140px;
            }
            .support-button.chat-active {
                right: 50%;
                transform: translateX(50%);
            }
        }
    </style>
</head>
<body>
    <div class="top-container">
        <div class="logo-section">
            <div class="top-logo-container">
                <img src="https://dondemeatiendo.essalud.gob.pe/assets/images/logo-essalud-v2.png" alt="Logo EsSalud">
            </div>
        </div>
        <div class="nav-section">
            <div class="nav-buttons">
                <button class="nav-button" onclick="window.location.href='GestionDeHorariosEssalud.html'">Consultar m√©dicos</button>
                <button class="nav-button" onclick="window.location.href='GenerarCita.html'">Gestionar Citas</button>
                <button class="nav-button" onclick="alert('Generando reportes (en desarrollo).')">Generar reportes</button>
                <button class="nav-button" onclick="window.location.href='lugardeatencion.html'">¬øD√≥nde me atiendo?</button>
                <button class="nav-button" onclick="window.location.href='Historialcitas.html'">Ver historial de citas</button>
            </div>
            <div class="relative">
                <button id="user-menu-button" class="user-menu-button">
                    <span id="user-initials">U</span>
                </button>
                <div id="user-menu" class="user-menu">
                    <a href="#" id="view-profile">Ver perfil</a>
                    <a href="#" id="logout">Cerrar sesi√≥n</a>
                </div>
            </div>
        </div>
    </div>
    
    <!-- MODAL DE PERFIL -->
    <div id="profile-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 500px;">
            <div class="modal-header">
                <h2>Mi Perfil</h2>
                <button class="modal-close" id="close-profile-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="profile-loader" style="text-align: center; padding: 40px;">
                    <div style="display: inline-block; width: 50px; height: 50px; border: 5px solid #f3f3f3; border-top: 5px solid #0078D7; border-radius: 50%; animation: spin 1s linear infinite;"></div>
                    <p style="margin-top: 20px; color: #666;">Cargando perfil...</p>
                </div>
                
                <div id="profile-content" style="display: none;">
                    <div class="profile-avatar" id="profile-avatar">
                        <span id="profile-avatar-text">U</span>
                    </div>
                    <div class="profile-info">
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #0078D7; font-size: 16px; margin-bottom: 10px; border-bottom: 2px solid #0078D7; padding-bottom: 5px;">üìã Informaci√≥n Personal</h3>
                            <div class="info-row">
                                <span class="info-label">Nombre:</span>
                                <span class="info-value" id="profile-name">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">C√≥digo:</span>
                                <span class="info-value" id="profile-code">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Documento:</span>
                                <span class="info-value" id="profile-document">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Fecha Nac.:</span>
                                <span class="info-value" id="profile-birth">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Edad:</span>
                                <span class="info-value" id="profile-age">-</span>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <h3 style="color: #0078D7; font-size: 16px; margin-bottom: 10px; border-bottom: 2px solid #0078D7; padding-bottom: 5px;">üìû Contacto</h3>
                            <div class="info-row">
                                <span class="info-label">Correo:</span>
                                <span class="info-value" id="profile-email">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Tel√©fono:</span>
                                <span class="info-value" id="profile-phone">-</span>
                            </div>
                        </div>
                        
                        <div>
                            <h3 style="color: #0078D7; font-size: 16px; margin-bottom: 10px; border-bottom: 2px solid #0078D7; padding-bottom: 5px;">‚öôÔ∏è Sistema</h3>
                            <div class="info-row">
                                <span class="info-label">Usuario:</span>
                                <span class="info-value" id="profile-username">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">ID Sistema:</span>
                                <span class="info-value" id="profile-id">-</span>
                            </div>
                            <div class="info-row">
                                <span class="info-label">Fecha Registro:</span>
                                <span class="info-value" id="profile-register-date">-</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="profile-error" style="display: none; text-align: center; padding: 40px; color: #d32f2f;">
                    <p style="font-size: 18px; margin-bottom: 10px;">‚ùå Error al cargar perfil</p>
                    <p id="profile-error-message" style="font-size: 14px;"></p>
                    <button onclick="loadUserProfile()" style="margin-top: 20px; padding: 10px 20px; background: #0078D7; color: white; border: none; border-radius: 8px; cursor: pointer;">Reintentar</button>
                </div>
            </div>
        </div>
    </div>
    
    <div class="decorative-image">
        <img src="https://pbs.twimg.com/media/Es7eTNcW4AAReWi.jpg:large" alt="Decoraci√≥n">
    </div>
    <div class="content">
    </div>
    
    <!-- CHAT WIDGET CON ROBOT 3D -->
    <button class="support-button" id="support-button">
        <canvas id="bot-canvas"></canvas>
    </button>

    <div class="chat-shell" id="chat-shell" role="application" aria-label="Chat de soporte">
        <div class="chat-header">
            <button id="minimize-chat" title="Minimizar chat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M4 12h16v2H4z"></path>
                </svg>
            </button>
            <button id="close-chat" title="Cerrar chat">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                    <path d="M6.707 5.293a1 1 0 0 0-1.414 1.414L10.586 12l-5.293 5.293a1 1 0 1 0 1.414 1.414L12 13.414l5.293 5.293a1 1 0 0 0 1.414-1.414L13.414 12l5.293-5.293a1 1 0 0 0-1.414-1.414L12 10.586 6.707 5.293z"></path>
                </svg>
            </button>
        </div>
        <div class="chat-body" id="chatBody">
        
        </div>
        <div class="ChatFooterHoveringButtonSection_section__6i4Bc">
            <span class="ChatFooterHoveringButtonSection_left__Lt5yM chat-floating-dot" title="left"></span>
            <span class="ChatFooterHoveringButtonSection_center__KuhMd chat-floating-dot" style="width:16px;height:16px" title="center"></span>
            <span class="ChatFooterHoveringButtonSection_right__Qbc1p chat-floating-dot" title="right"></span>
        </div>
        <div class="ChatPageMainFooter_footerInner__BEj26" role="region" aria-label="√Årea de entrada de mensaje">
            <div>
                <div class="ChatMessageInputFooter_footer__v4dFF">
                    <div class="ChatMessageInputContainer_inputContainer__s2AGa" data-input-is-empty="true" tabindex="-1">
                        <div class="GrowingTextArea_growWrap__im5W3 ChatMessageInputContainer_textArea__fNi6E" data-replicated-value="">
                            <textarea class="GrowingTextArea_textArea__ZWQbP"
                                      rows="1"
                                      placeholder="Mensaje"
                                      aria-label="Escribe un mensaje"></textarea>
                            <div class="GrowingTextArea_hidden__xLW0K" aria-hidden="true"></div>
                        </div>
                        <div class="ChatMessageInputContainer_actionContainerLeft__dIwkm ChatMessageInputContainer_actionContainerBase__8BKrX">
                            <div>
                                <button class="button_root__TL8nv button_ghost__YsMI5 button_sm__hWzjK button_center__RsQ_o button_showIconOnly-always__05Gb5"
                                        type="button"
                                        aria-label="Borrar contexto"
                                        data-button-chat-break="true"
                                        title="Borrar contexto">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                        <path d="M17 10.5h-3.5V4c0-1.378-1.122-2.5-2.5-2.5A2.503 2.503 0 0 0 8.5 4v6.5H5a1 1 0 0 0-1 1v3a.99.99 0 0 0 .894.979 19 19 0 0 1-.365 1.779 11.6 11.6 0 0 1-1.363 3.188A1 1 0 0 0 4 22h3.5a1 1 0 0 0 .949-.684l.051-.154.051.154A1 1 0 0 0 9.5 22H14c.334 0 .646-.167.832-.445.045-.067 1.103-1.669 1.638-3.812.242-.968.372-1.708.443-2.242H17a1 1 0 0 0 1-1v-3a1 1 0 0 0-1-1.001M10.5 4a.5.5 0 0 1 1 0v6.5h-1zM6 12.5h10v1H6zm8.53 4.758A11.7 11.7 0 0 1 13.431 20H10.22l-.772-2.316a.998.998 0 0 0-1.897 0L6.779 20H5.671c.284-.622.584-1.396.799-2.258.242-.968.371-1.708.443-2.242h7.979a20 20 0 0 1-.362 1.758M18.5 21.5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3M21 18a1 1 0 1 0 0-2 1 1 0 0 0 0 2"></path>
                                    </svg>
                                    <span class="button_label__mCaDf"></span>
                                </button>
                            </div>
                            <div class="ChatMessageInputContainer_breakSeparator__6WnHy" aria-hidden="true"></div>
                            <div>
                                <button class="button_root__TL8nv button_ghost__YsMI5 button_sm__hWzjK button_center__RsQ_o button_showIconOnly-always__05Gb5"
                                        type="button"
                                        aria-label="Seleccionar adjunto"
                                        data-button-file-input="true"
                                        title="Adjuntar archivo">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                        <path d="M13 4.5a1 1 0 1 0-2 0V11H4.5a1 1 0 1 0 0 2H11v6.5a1 1 0 1 0 2 0V13h6.5a1 1 0 1 0 0-2H13z"></path>
                                    </svg>
                                    <span class="button_label__mCaDf"></span>
                                </button>
                            </div>
                            <input class="ChatMessageFileInputButton_input__svNx4" type="file" multiple aria-hidden="true" />
                        </div>
                        <div class="ChatMessageInputContainer_actionContainerRight__fyfsX ChatMessageInputContainer_actionContainerBase__8BKrX">
                            <div class="ChatMessageVoiceInputButton_container__B5Uev">
                                <button class="button_root__TL8nv button_ghost__YsMI5 button_sm__hWzjK button_center__RsQ_o button_isDisabled__pJu5B button_showIconOnly-always__05Gb5 ChatMessageVoiceInputButton_button__NjXno"
                                        type="button"
                                        aria-selected="false"
                                        data-button-voice-input="true"
                                        disabled
                                        title="Entrada de voz (no disponible)">
                                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                        <path d="M12 15.452a3.55 3.55 0 0 0 3.543-3.543V5.543A3.547 3.547 0 0 0 12 2a3.547 3.547 0 0 0-3.543 3.543v6.366A3.547 3.547 0 0 0 12 15.452m-1.543-9.909C10.457 4.692 11.149 4 12 4s1.543.692 1.543 1.543v6.366c0 .851-.692 1.543-1.543 1.543a1.545 1.545 0 0 1-1.543-1.543z"></path>
                                        <path d="M18.775 12.139v-1.3a1 1 0 1 0-2 0v1.3a4.48 4.48 0 0 1-4.474 4.474h-.291l-.01-.002-.01.002h-.292a4.48 4.48 0 0 1-4.474-4.474v-1.3a1 1 0 0 0-2 0v1.3c0 3.334 2.533 6.085 5.775 6.435V20H8a1 1 0 1 0 0 2h8a1 1 0 1 0 0-2h-3v-1.426c3.242-.35 5.775-3.101 5.775-6.435"></path>
                                    </svg>
                                </button>
                            </div>
                            <button class="button_root__TL8nv button_ghost__YsMI5 button_sm__hWzjK button_center__RsQ_o button_isDisabled__pJu5B button_showIconOnly-always__05Gb5"
                                    type="button"
                                    aria-label="Enviar mensaje"
                                    data-button-send="true"
                                    data-theme="ghost"
                                    disabled
                                    title="Enviar">
                                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true">
                                    <path d="M4 11h14.09L11.3 4.21a.996.996 0 1 1 1.41-1.41l8.5 8.5c.06.06.09.13.13.2.03.04.06.08.08.13.05.11.08.24.08.37 0 .03-.01.05-.01.07-.01.1-.02.21-.06.31-.05.13-.13.24-.22.33l-8.49 8.49c-.2.2-.45.29-.71.29s-.51-.1-.71-.29a.996.996 0 0 1 0-1.41L18.08 13H4c-.55 0-1-.45-1-1s.45-1 1-1"></path>
                                </svg>
                                <span class="button_label__mCaDf"></span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script>
        // ============ FUNCIONES PERFIL ============
        async function loadUserProfile() {
            const userId = localStorage.getItem('userId');
            
            if (!userId) {
                alert('No se encontr√≥ informaci√≥n de sesi√≥n');
                window.location.href = 'index.html';
                return;
            }
            
            document.getElementById('profile-loader').style.display = 'block';
            document.getElementById('profile-content').style.display = 'none';
            document.getElementById('profile-error').style.display = 'none';
            
            try {
                const response = await fetch('https://cirochat.duckdns.org/get_patient_profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        id_paciente: userId
                    })
                });
                
                const data = await response.json();
                
                if (!response.ok || !data.success) {
                    throw new Error(data.message || 'Error al obtener perfil');
                }
                
                const perfil = data.perfil;
                
                const initials = perfil.nombre_completo.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
                document.getElementById('profile-avatar-text').textContent = initials;
                
                document.getElementById('profile-name').textContent = perfil.nombre_completo;
                document.getElementById('profile-code').textContent = perfil.codigo_paciente;
                document.getElementById('profile-document').textContent = `${perfil.tipo_documento}: ${perfil.numero_documento}`;
                document.getElementById('profile-birth').textContent = perfil.fecha_nacimiento;
                document.getElementById('profile-age').textContent = perfil.edad ? `${perfil.edad} a√±os` : 'No disponible';
                
                document.getElementById('profile-email').textContent = perfil.correo;
                document.getElementById('profile-phone').textContent = perfil.telefono;
                
                document.getElementById('profile-username').textContent = perfil.usuario;
                document.getElementById('profile-id').textContent = perfil.id_paciente;
                document.getElementById('profile-register-date').textContent = perfil.fecha_registro;
                
                document.getElementById('profile-loader').style.display = 'none';
                document.getElementById('profile-content').style.display = 'block';
                
            } catch (error) {
                console.error('Error cargando perfil:', error);
                
                document.getElementById('profile-loader').style.display = 'none';
                document.getElementById('profile-error').style.display = 'block';
                document.getElementById('profile-error-message').textContent = error.message;
            }
        }

        document.getElementById('view-profile').addEventListener('click', function(e) {
            e.preventDefault();
            document.getElementById('profile-modal').classList.add('active');
            document.getElementById('user-menu').style.display = 'none';
            loadUserProfile();
        });

        document.getElementById('close-profile-modal').addEventListener('click', function() {
            document.getElementById('profile-modal').classList.remove('active');
        });

        document.getElementById('profile-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
            }
        });

        // ============ ROBOT 3D ============
        let scene, camera, renderer, robot;
        let leftPupil, rightPupil, leftShine, rightShine;
        let leftEye, rightEye;
        let mouseX = 0, mouseY = 0;
        let targetRotationX = 0, targetRotationY = 0;
        let isChatOpen = false;

        function initBot() {
            const canvas = document.getElementById('bot-canvas');
            
            scene = new THREE.Scene();
            updateSceneBackground();

            camera = new THREE.PerspectiveCamera(50, 1, 0.1, 1000);
            camera.position.set(0, 0, 15);

            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            
            updateRendererSize();
            renderer.shadowMap.enabled = true;

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
            scene.add(ambientLight);

            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.5);
            directionalLight.position.set(5, 10, 10);
            directionalLight.castShadow = true;
            scene.add(directionalLight);

            createRobot();
            document.addEventListener('mousemove', onMouseMove);
            animateBot();
        }

        function updateSceneBackground() {
            if (isChatOpen) {
                scene.background = null;
            } else {
                scene.background = new THREE.Color(0xffffff);
            }
        }

        function updateRendererSize() {
            const container = document.getElementById('support-button');
            const size = isChatOpen ? 150 : 100;
            renderer.setSize(size, size);
        }

        function onMouseMove(event) {
            if (isChatOpen) {
                mouseX = (event.clientX / window.innerWidth) * 2 - 1;
                mouseY = (event.clientY / window.innerHeight) * 2 - 1;

                targetRotationY = mouseX * 0.5;
                targetRotationX = mouseY * 0.5;
            }
        }

        function createRobot() {
            robot = new THREE.Group();

            const canvas = document.createElement('canvas');
            canvas.width = 256;
            canvas.height = 256;
            const ctx = canvas.getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 256);
            gradient.addColorStop(0, '#00FFCC');
            gradient.addColorStop(1, '#00CC66');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 256, 256);
            const gradientTexture = new THREE.CanvasTexture(canvas);

            const headGeometry = new THREE.SphereGeometry(3, 32, 32);
            const headMaterial = new THREE.MeshPhongMaterial({
                map: gradientTexture,
                shininess: 30
            });
            const head = new THREE.Mesh(headGeometry, headMaterial);
            head.scale.set(1, 0.75, 0.6);
            head.castShadow = true;
            robot.add(head);

            const goggleGeometry = new THREE.SphereGeometry(1, 32, 32);
            const goggleMaterial = new THREE.MeshPhongMaterial({
                color: 0x66CCFF,
                shininess: 60,
                transparent: true,
                opacity: 0.85
            });

            const leftGoggle = new THREE.Mesh(goggleGeometry, goggleMaterial);
            leftGoggle.position.set(-1.3, 1.2, 1.5);
            leftGoggle.scale.set(1.3, 0.9, 0.4);
            robot.add(leftGoggle);

            const rightGoggle = new THREE.Mesh(goggleGeometry, goggleMaterial);
            rightGoggle.position.set(1.3, 1.2, 1.5);
            rightGoggle.scale.set(1.3, 0.9, 0.4);
            robot.add(rightGoggle);

            const goggleRimGeometry = new THREE.TorusGeometry(1.15, 0.08, 16, 32);
            const rimMaterial = new THREE.MeshPhongMaterial({
                color: 0x3399FF,
                shininess: 80
            });

            const leftRim = new THREE.Mesh(goggleRimGeometry, rimMaterial);
            leftRim.position.set(-1.3, 1.2, 1.7);
            leftRim.scale.set(1.13, 0.78, 1);
            robot.add(leftRim);

            const rightRim = new THREE.Mesh(goggleRimGeometry, rimMaterial);
            rightRim.position.set(1.3, 1.2, 1.7);
            rightRim.scale.set(1.13, 0.78, 1);
            robot.add(rightRim);

            const faceGeometry = new THREE.SphereGeometry(2.5, 32, 32);
            const faceMaterial = new THREE.MeshPhongMaterial({
                color: 0xFFFFFF,
                shininess: 40
            });
            const face = new THREE.Mesh(faceGeometry, faceMaterial);
            face.position.set(0, -0.8, 1.2);
            face.scale.set(0.95, 0.36, 0.45);
            robot.add(face);

            const eyeGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            const eyeMaterial = new THREE.MeshPhongMaterial({
                color: 0x000000,
                shininess: 100
            });

            leftEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            leftEye.position.set(-0.8, -0.5, 2.1);
            robot.add(leftEye);

            rightEye = new THREE.Mesh(eyeGeometry, eyeMaterial);
            rightEye.position.set(0.8, -0.5, 2.1);
            robot.add(rightEye);

            const pupilGeometry = new THREE.SphereGeometry(0.2, 16, 16);
            const pupilMaterial = new THREE.MeshPhongMaterial({
                color: 0x00c4ff,
                emissive: 0x00c4ff,
                emissiveIntensity: 0.4,
                shininess: 100
            });

            leftPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            leftPupil.position.set(-0.8, -0.5, 2.5);
            robot.add(leftPupil);

            rightPupil = new THREE.Mesh(pupilGeometry, pupilMaterial);
            rightPupil.position.set(0.8, -0.5, 2.5);
            robot.add(rightPupil);

            const shineGeometry = new THREE.SphereGeometry(0.08, 8, 8);
            const shineMaterial = new THREE.MeshBasicMaterial({
                color: 0x00ffff
            });

            leftShine = new THREE.Mesh(shineGeometry, shineMaterial);
            leftShine.position.set(-0.7, -0.4, 2.65);
            robot.add(leftShine);

            rightShine = new THREE.Mesh(shineGeometry, shineMaterial);
            rightShine.position.set(0.9, -0.4, 2.65);
            robot.add(rightShine);

            const shoulderGeometry = new THREE.SphereGeometry(0.5, 32, 32);
            const shoulderMaterial = new THREE.MeshPhongMaterial({
                map: gradientTexture,
                shininess: 60
            });

            const leftShoulder = new THREE.Mesh(shoulderGeometry, shoulderMaterial);
            leftShoulder.position.set(-3.2, 0.5, 0);
            robot.add(leftShoulder);

            const rightShoulder = new THREE.Mesh(shoulderGeometry, shoulderMaterial);
            rightShoulder.position.set(3.2, 0.5, 0);
            robot.add(rightShoulder);

            const armGeometry = new THREE.BoxGeometry(0.8, 1.8, 0.8);
            const armMaterial = new THREE.MeshPhongMaterial({
                color: 0x00BFFF,
                shininess: 50
            });

            const leftArm = new THREE.Mesh(armGeometry, armMaterial);
            leftArm.position.set(-3.8, 0, 0);
            robot.add(leftArm);

            const rightArm = new THREE.Mesh(armGeometry, armMaterial);
            rightArm.position.set(3.8, 0, 0);
            robot.add(rightArm);

            const antennaGeometry = new THREE.SphereGeometry(0.3, 16, 16);
            const antennaMaterial = new THREE.MeshPhongMaterial({
                color: 0x00FFFF,
                emissive: 0x00FFFF,
                emissiveIntensity: 0.5
            });

            const leftAntenna = new THREE.Mesh(antennaGeometry, antennaMaterial);
            leftAntenna.position.set(-3.8, 1.2, 0);
            robot.add(leftAntenna);

            const rightAntenna = new THREE.Mesh(antennaGeometry, antennaMaterial);
            rightAntenna.position.set(3.8, 1.2, 0);
            robot.add(rightAntenna);

            scene.add(robot);
        }

        let blinkTime = 0;
        let nextBlink = 3000;
        let isBlinking = false;

        function animateBot() {
            requestAnimationFrame(animateBot);

            if (isChatOpen) {
                robot.rotation.y += (targetRotationY - robot.rotation.y) * 0.05;
                robot.rotation.x += (targetRotationX - robot.rotation.x) * 0.05;

                const pupilMoveX = mouseX * 0.2;
                const pupilMoveY = -mouseY * 0.2;

                leftPupil.position.x = -0.8 + pupilMoveX;
                leftPupil.position.y = -0.5 + pupilMoveY;
                rightPupil.position.x = 0.8 + pupilMoveX;
                rightPupil.position.y = -0.5 + pupilMoveY;

                leftShine.position.x = -0.7 + pupilMoveX;
                leftShine.position.y = -0.4 + pupilMoveY;
                rightShine.position.x = 0.9 + pupilMoveX;
                rightShine.position.y = -0.4 + pupilMoveY;
            } else {
                robot.rotation.y += 0.01;
            }

            blinkTime += 16;
            if (blinkTime > nextBlink && !isBlinking) {
                isBlinking = true;
                blinkEyes();
                blinkTime = 0;
                nextBlink = 2800 + Math.random() * 1200;
            }

            renderer.render(scene, camera);
        }

        function blinkEyes() {
            leftEye.scale.y = 0.1;
            rightEye.scale.y = 0.1;
            leftPupil.scale.y = 0.1;
            rightPupil.scale.y = 0.1;
            leftShine.scale.y = 0.1;
            rightShine.scale.y = 0.1;

            setTimeout(() => {
                leftEye.scale.y = 1;
                rightEye.scale.y = 1;
                leftPupil.scale.y = 1;
                rightPupil.scale.y = 1;
                leftShine.scale.y = 1;
                rightShine.scale.y = 1;
                isBlinking = false;
            }, 180);
        }

        window.addEventListener('load', function() {
            const userId = localStorage.getItem('userId');
            if (!userId) {
                alert('No has iniciado sesi√≥n. Ser√°s redirigido a la p√°gina de inicio.');
                window.location.href = 'index.html';
                return;
            }
            personalizeScripts();
            initBot();
        });

        function personalizeScripts() {
            const workerName = localStorage.getItem('workerName') || 'Usuario';
            const initials = workerName.split(' ').map(word => word.charAt(0)).join('').substring(0, 2).toUpperCase();
            document.getElementById('user-initials').textContent = initials;
        }

        document.getElementById('user-menu-button').addEventListener('click', function(e) {
            const menu = document.getElementById('user-menu');
            menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
            e.stopPropagation();
        });

        document.getElementById('logout').addEventListener('click', function(e) {
            e.preventDefault();
            const confirmLogout = confirm("¬øEst√°s seguro de que deseas cerrar sesi√≥n?");
            if (confirmLogout) {
                localStorage.clear();
                alert("Sesi√≥n cerrada correctamente.");
                window.location.href = 'index.html';
            }
            document.getElementById('user-menu').style.display = 'none';
        });

        document.addEventListener('click', function(e) {
            const menu = document.getElementById('user-menu');
            const button = document.getElementById('user-menu-button');
            if (!menu.contains(e.target) && e.target !== button) {
                menu.style.display = 'none';
            }
        });

        const supportButton = document.getElementById('support-button');
        const chatShell = document.getElementById('chat-shell');
        
        supportButton.addEventListener('click', function() {
            chatShell.classList.toggle('active');
            isChatOpen = chatShell.classList.contains('active');
            
            if (isChatOpen) {
                supportButton.classList.add('chat-active');
                updateRendererSize();
                updateSceneBackground();
                mouseX = 0;
                mouseY = 0;
                targetRotationX = 0;
                targetRotationY = 0;
            } else {
                supportButton.classList.remove('chat-active');
                updateRendererSize();
                updateSceneBackground();
            }
        });

        document.getElementById('close-chat').addEventListener('click', function() {
            chatShell.classList.remove('active');
            supportButton.classList.remove('chat-active');
            isChatOpen = false;
            updateRendererSize();
            updateSceneBackground();
        });

        document.getElementById('minimize-chat').addEventListener('click', function() {
            chatShell.classList.remove('active');
            supportButton.classList.remove('chat-active');
            isChatOpen = false;
            updateRendererSize();
            updateSceneBackground();
        });

        // ============ CHAT GEMINI FUNCTIONALITY ============
        (function(){
            const textarea = document.querySelector('textarea.GrowingTextArea_textArea__ZWQbP');
            const sendBtn = document.querySelector('[data-button-send]');
            const fileBtn = document.querySelector('[data-button-file-input]');
            const fileInput = document.querySelector('input.ChatMessageFileInputButton_input__svNx4');
            const clearBtn = document.querySelector('[data-button-chat-break]');
            const chatBody = document.getElementById('chatBody');
            const voiceBtn = document.querySelector('[data-button-voice-input]');
            let recognition;
            let isRecording = false;
            
            function initSpeechRecognition() {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                
                if (!SpeechRecognition) {
                    console.warn('Speech Recognition no est√° soportado en este navegador');
                    return null;
                }
                
                recognition = new SpeechRecognition();
                recognition.lang = 'es-PE';
                recognition.continuous = false;
                recognition.interimResults = false;
                
                recognition.onresult = (event) => {
                    const transcript = event.results[0][0].transcript;
                    textarea.value = transcript;
                    syncHeight();
                    updateState();
                };
                
                recognition.onerror = (event) => {
                    console.error('Error en reconocimiento de voz:', event.error);
                    stopRecording();
                    alert('Error al reconocer voz: ' + event.error);
                };
                
                recognition.onend = () => {
                    stopRecording();
                };
                
                return recognition;
            }

            function startRecording() {
                if (recognition) {
                    try {
                        recognition.stop();
                    } catch (e) {}
                }
                
                recognition = initSpeechRecognition();
                
                if (!recognition) {
                    alert('Reconocimiento de voz no disponible en este navegador');
                    return;
                }
                
                isRecording = true;
                voiceBtn.style.background = '#ff4444';
                voiceBtn.querySelector('svg').style.color = '#ffffff';
                
                try {
                    recognition.start();
                } catch (e) {
                    console.error('Error al iniciar grabaci√≥n:', e);
                    stopRecording();
                    alert('No se pudo iniciar el reconocimiento de voz. Intenta de nuevo.');
                }
            }

            function stopRecording() {
                isRecording = false;
                voiceBtn.style.background = '';
                voiceBtn.querySelector('svg').style.color = '';
                
                if (recognition) {
                    try {
                        recognition.stop();
                        recognition = null;
                    } catch (e) {}
                }
            }
            
            recognition = initSpeechRecognition();

            if (recognition) {
                voiceBtn.disabled = false;
                voiceBtn.title = 'Entrada de voz (clic para grabar)';
                voiceBtn.classList.remove('button_isDisabled__pJu5B');
                
                voiceBtn.addEventListener('click', (e) => {
                    e.preventDefault();
                    if (isRecording) {
                        stopRecording();
                    } else {
                        startRecording();
                    }
                });
            }

            function syncHeight() {
                textarea.style.height = 'auto';
                const h = textarea.scrollHeight;
                textarea.style.height = (Math.min(h, 160)) + 'px';
            }

            function updateState() {
                const empty = textarea.value.trim().length === 0;
                sendBtn.disabled = empty;
                const container = document.querySelector('.ChatMessageInputContainer_inputContainer__s2AGa');
                container.setAttribute('data-input-is-empty', empty ? 'true' : 'false');
            }

            textarea.addEventListener('input', () => {
                syncHeight();
                updateState();
            });

            fileBtn.addEventListener('click', (e) => {
                e.preventDefault();
                fileInput.click();
            });

            fileInput.addEventListener('change', (e) => {
                const files = e.target.files;
                if (files.length) {
                    const p = document.createElement('div');
                    p.style.opacity = '.9';
                    p.style.fontSize = '13px';
                    p.style.marginBottom = '8px';
                    p.textContent = 'Archivo(s) adjuntos: ' + Array.from(files).map(f => f.name).join(', ');
                    chatBody.appendChild(p);
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            });

            clearBtn.addEventListener('click', (e) => {
                e.preventDefault();
                if (confirm('¬øBorrar todo el contexto del chat?')) {
                    chatBody.innerHTML = '<p style="opacity:.6">¬°Hola! Soy Ciro, tu asistente m√©dico. üëã ¬øEn qu√© puedo ayudarte?</p>';
                }
            });

            function createMessageBubble(sender, content, isError = false) {
                const bubble = document.createElement('div');
                if (isError) {
                    bubble.style.background = '#ffebee';
                    bubble.style.color = '#c62828';
                    bubble.style.borderLeft = '4px solid #d32f2f';
                } else if (sender === 'T√∫') {
                    bubble.style.background = '#0078D7';
                    bubble.style.color = '#ffffff';
                    bubble.style.marginLeft = 'auto';
                    bubble.style.maxWidth = '85%';
                    bubble.style.borderRadius = '12px 12px 4px 12px';
                } else {
                    bubble.style.background = 'white';
                    bubble.style.color = '#333';
                    bubble.style.border = '1px solid #e0e0e0';
                    bubble.style.borderLeft = '4px solid #0078D7';
                    bubble.style.maxWidth = '85%';
                }
                bubble.style.padding = '12px 14px';
                bubble.style.borderRadius = bubble.style.borderRadius || '12px';
                bubble.style.marginBottom = '8px';
                bubble.style.fontSize = '14px';
                bubble.style.lineHeight = '1.4';
                bubble.textContent = `${sender}: ${content}`;
                return bubble;
            }

            function createOptionsButtons(options) {
                const optionsContainer = document.createElement('div');
                optionsContainer.className = 'chat-options';
                options.forEach((option, index) => {
                    const button = document.createElement('button');
                    button.className = 'chat-option-button';
                    button.textContent = option.text;
                    button.addEventListener('click', () => {
                        sendMessage(option.text);
                    });
                    optionsContainer.appendChild(button);
                });
                return optionsContainer;
            }

            function parseMenuResponse(response) {
                const lines = response.split('\n');
                const menuItems = lines.filter(line => line.match(/^\d+\.\s/));
                
                if (menuItems.length > 0) {
                    const options = menuItems.map(line => ({
                        number: line.match(/^\d+/)[0],
                        text: line.replace(/^\d+\.\s/, '').trim()
                    }));
                    return { text: lines.filter(line => !line.match(/^\d+\.\s/)).join('\n').trim(), options };
                }
                return { text: response, options: [] };
            }

            async function sendMessage(message) {
                if (sendBtn.disabled && !message) return;
                const mensaje = message || textarea.value.trim();
                if (!mensaje) return;

                const userBubble = createMessageBubble('T√∫', mensaje);
                chatBody.appendChild(userBubble);
                chatBody.scrollTop = chatBody.scrollHeight;

                textarea.value = '';
                syncHeight();
                updateState();

                sendBtn.disabled = true;
                textarea.disabled = true;

                const dots = document.querySelectorAll('.chat-floating-dot');
                dots.forEach(dot => dot.classList.add('pulsing'));

                const typingBubble = document.createElement('div');
                typingBubble.id = 'typing-bubble';
                typingBubble.style.background = '#0078D7';
                typingBubble.style.padding = '10px 12px';
                typingBubble.style.borderRadius = '10px';
                typingBubble.style.marginBottom = '8px';
                typingBubble.style.color = '#ffffff';
                typingBubble.style.opacity = '0.7';
                typingBubble.textContent = 'Ciro est√° pensando... üß†';
                chatBody.appendChild(typingBubble);
                chatBody.scrollTop = chatBody.scrollHeight;

                try {
                    const res = await fetch("https://cirochat.duckdns.org/generar_cliente", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ mensaje, session_id: localStorage.getItem('userId') || 'default' })
                    });
                    const data = await res.json();
                    
                    if (document.getElementById('typing-bubble')) {
                        document.getElementById('typing-bubble').remove();
                    }
                    
                    dots.forEach(dot => dot.classList.remove('pulsing'));
                    
                    textarea.disabled = false;
                    updateState();
                    
                    const { text, options } = parseMenuResponse(data.respuesta || '');
                    
                    if (text) {
                        const botBubble = createMessageBubble('Ciro', text);
                        chatBody.appendChild(botBubble);
                    }
                    
                    if (options.length > 0) {
                        const optionsContainer = createOptionsButtons(options);
                        chatBody.appendChild(optionsContainer);
                    }
                    
                    chatBody.scrollTop = chatBody.scrollHeight;

                } catch (err) {
                    if (document.getElementById('typing-bubble')) {
                        document.getElementById('typing-bubble').remove();
                    }
                    
                    dots.forEach(dot => dot.classList.remove('pulsing'));
                    
                    textarea.disabled = false;
                    updateState();
                    
                    const errorBubble = createMessageBubble('Error', err.message, true);
                    chatBody.appendChild(errorBubble);
                    chatBody.scrollTop = chatBody.scrollHeight;
                }
            }

            sendBtn.addEventListener('click', () => sendMessage());

            textarea.addEventListener('keypress', (e) => {
                if (e.key === "Enter" && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            syncHeight();
            updateState();
        })();
    </script>
</body>

</html>
